---
phase: 01-foundation-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - ecosystem.config.js
  - .gitignore
  - src/auth/authState.ts
autonomous: true

must_haves:
  truths:
    - "Project has TypeScript configured with modern ES modules support"
    - "Dependencies are installed and locked to specific versions"
    - "PM2 can run the TypeScript bot using tsx interpreter"
    - "Session files persist across process restarts without corruption"
    - "Auth state can save and load credentials atomically"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "@whiskeysockets/baileys"
    - path: "tsconfig.json"
      provides: "TypeScript compilation config"
      contains: "\"module\": \"ESNext\""
    - path: "ecosystem.config.js"
      provides: "PM2 process configuration"
      contains: "interpreter: 'tsx'"
    - path: "src/auth/authState.ts"
      provides: "Custom auth state with atomic writes"
      exports: ["useJsonAuthState"]
      min_lines: 50
    - path: ".gitignore"
      provides: "Excludes session data from git"
      contains: "data/auth"
  key_links:
    - from: "src/auth/authState.ts"
      to: "write-file-atomic"
      via: "import"
      pattern: "import.*write-file-atomic"
    - from: "ecosystem.config.js"
      to: "src/index.ts"
      via: "script path"
      pattern: "script.*index\\.ts"
---

<objective>
Establish project foundation with TypeScript, dependencies, and production-grade auth state management.

Purpose: Create the foundational project structure and implement atomic session persistence to prevent session corruption on crashes (requirement INFRA-01).
Output: Configured Node.js/TypeScript project with custom JSON-based auth state using write-file-atomic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-connection/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project Setup & Configuration</name>
  <files>
    package.json
    tsconfig.json
    ecosystem.config.js
    .gitignore
  </files>
  <action>
Create Node.js/TypeScript project structure per RESEARCH.md recommendations.

**package.json:**
- Initialize with npm init
- Add dependencies: @whiskeysockets/baileys@7.0.0-rc.9, pino@^9.0.0, write-file-atomic@^5.0.0
- Add devDependencies: typescript@^5.0.0, tsx@^4.0.0, @types/node@latest, qrcode-terminal@^0.12.0
- Add scripts: "start": "tsx src/index.ts", "dev": "tsx watch src/index.ts"
- Set "type": "module" for ES modules

**tsconfig.json:**
- Target: ES2022
- Module: ESNext
- ModuleResolution: bundler
- Strict: true
- RootDir: ./src
- OutDir: ./dist
- Include: ["src/**/*"]

**ecosystem.config.js:**
- Name: 'soccer-bot'
- Script: './src/index.ts'
- Interpreter: 'tsx'
- Instances: 1 (MUST be 1 for tsx - fork mode only, NOT cluster)
- Autorestart: true
- Max memory restart: 500M
- Error/out files: ./logs/error.log, ./logs/out.log

**.gitignore:**
- Add: node_modules/, dist/, logs/, data/auth/, .env
- Preserve: .planning/, .claude/

Create directory structure: src/auth/, src/handlers/, src/utils/, src/config/, data/auth/, logs/
  </action>
  <verify>
npm install runs without errors
tsc --noEmit validates TypeScript config
ls -la shows src/, data/, logs/ directories created
  </verify>
  <done>
package.json exists with Baileys 7.0.0-rc.9 and all required dependencies
tsconfig.json targets ES2022 with ESNext modules
ecosystem.config.js configured for tsx with fork mode (instances: 1)
Project structure matches RESEARCH.md recommended layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Custom Auth State Implementation</name>
  <files>
    src/auth/authState.ts
  </files>
  <action>
Implement production-grade auth state using write-file-atomic (NOT Baileys' useMultiFileAuthState - research explicitly warns against production use due to I/O issues).

**src/auth/authState.ts:**

Create `useJsonAuthState(dataDir: string)` function that:
1. Defines paths: `creds.json` and `keys.json` in dataDir
2. Loads existing state from files (handle missing files â†’ initialize empty)
3. Returns object with:
   - `state: { creds, keys }` - current auth state
   - `saveCreds: async () => void` - atomically writes creds using write-file-atomic
   - `saveKeys: async () => void` - atomically writes keys using write-file-atomic

Implementation details:
- Use `writeFile` from 'write-file-atomic' (NOT fs.writeFile - prevents corruption on kill -9)
- Use `readFile` from 'fs/promises' for loading
- Stringify JSON with 2-space indentation for readability
- Catch read errors and initialize empty objects {} for first run
- Export function as named export

Follow the pattern from RESEARCH.md "Pattern 1: Custom Auth State for JSON Storage" but use proper TypeScript types from Baileys (AuthenticationCreds, SignalDataTypeMap).

Do NOT use useMultiFileAuthState from Baileys - this is a custom implementation replacing it.
  </action>
  <verify>
tsc --noEmit validates types
grep "write-file-atomic" src/auth/authState.ts confirms atomic writes
grep "export.*useJsonAuthState" src/auth/authState.ts confirms export
  </verify>
  <done>
src/auth/authState.ts exists and exports useJsonAuthState function
Function uses write-file-atomic for atomic session persistence
TypeScript compiles without errors
Code matches production-grade pattern from research (NOT built-in useMultiFileAuthState)
  </done>
</task>

</tasks>

<verification>
1. Run `npm install` - should complete without errors
2. Run `tsc --noEmit` - should validate with no type errors
3. Verify src/auth/authState.ts uses write-file-atomic (not fs.writeFile)
4. Verify ecosystem.config.js has instances: 1 (fork mode for tsx)
5. Verify .gitignore excludes data/auth/ directory
</verification>

<success_criteria>
- package.json contains @whiskeysockets/baileys@7.0.0-rc.9 and all required dependencies
- tsconfig.json configured for ESNext modules with strict mode
- ecosystem.config.js ready for PM2 with tsx interpreter in fork mode
- src/auth/authState.ts implements atomic session persistence using write-file-atomic
- Project structure matches recommended layout: src/auth/, src/handlers/, src/utils/, src/config/
- All TypeScript files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-connection/01-01-SUMMARY.md`
</output>
