---
phase: 01-foundation-connection
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/index.ts
  - src/handlers/connection.ts
  - src/handlers/credentials.ts
  - src/utils/logger.ts
  - src/utils/errors.ts
  - src/config/env.ts
  - .env.example
autonomous: false

must_haves:
  truths:
    - "Bot connects to WhatsApp and displays QR code for scanning"
    - "After QR scan, bot maintains active connection to WhatsApp"
    - "Bot reconnects automatically after network interruptions"
    - "Bot does NOT reconnect after explicit logout (prevents infinite QR loop)"
    - "Session credentials persist after kill -9 and survive restart without re-scan"
    - "Uncaught errors cause graceful exit allowing PM2 to restart"
  artifacts:
    - path: "src/index.ts"
      provides: "Main entry point with socket initialization"
      min_lines: 30
      contains: "makeWASocket"
    - path: "src/handlers/connection.ts"
      provides: "Connection state handler with reconnection logic"
      exports: ["handleConnectionUpdate"]
      contains: "DisconnectReason.loggedOut"
    - path: "src/handlers/credentials.ts"
      provides: "Credentials update handler"
      exports: ["handleCredsUpdate"]
    - path: "src/utils/logger.ts"
      provides: "Pino logger instance"
      exports: ["logger"]
    - path: "src/utils/errors.ts"
      provides: "Global error handlers"
      contains: "process.on"
    - path: "src/config/env.ts"
      provides: "Environment variable validation"
      exports: ["config"]
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "GROUP_1_JID"
  key_links:
    - from: "src/index.ts"
      to: "src/auth/authState.ts"
      via: "useJsonAuthState import"
      pattern: "import.*useJsonAuthState"
    - from: "src/index.ts"
      to: "makeWASocket"
      via: "Baileys socket creation"
      pattern: "makeWASocket\\("
    - from: "src/handlers/connection.ts"
      to: "DisconnectReason.loggedOut"
      via: "reconnection guard"
      pattern: "DisconnectReason\\.loggedOut"
    - from: "src/index.ts"
      to: "src/utils/errors.ts"
      via: "global error handler setup"
      pattern: "setupErrorHandlers"
---

<objective>
Implement WhatsApp socket connection with persistent session, automatic reconnection, and graceful error handling.

Purpose: Connect bot to WhatsApp with production-grade session persistence, preventing QR re-scans on restart and handling disconnections intelligently (requirements INFRA-01, INFRA-02, INFRA-05, INFRA-06).
Output: Working WhatsApp bot that authenticates once, reconnects automatically, and maintains connection to both groups across restarts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-connection/01-RESEARCH.md
@.planning/phases/01-foundation-connection/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Socket Connection & Event Handlers</name>
  <files>
    src/index.ts
    src/handlers/connection.ts
    src/handlers/credentials.ts
    src/utils/logger.ts
    src/utils/errors.ts
    src/config/env.ts
    .env.example
  </files>
  <action>
Implement WhatsApp socket initialization with connection handling, following RESEARCH.md patterns.

**src/config/env.ts:**
- Validate and export environment variables
- Required: GROUP_1_JID (managers group), GROUP_2_JID (players group)
- Optional: NODE_ENV (default: 'production'), LOG_LEVEL (default: 'info')
- Throw error if required vars missing

**src/utils/logger.ts:**
- Create Pino logger instance with level from env.LOG_LEVEL
- Export as `logger`

**src/utils/errors.ts:**
- Export `setupErrorHandlers()` function
- Register `process.on('uncaughtException', handler)` - log error and exit(1)
- Register `process.on('unhandledRejection', handler)` - log rejection and exit(1)
- PM2 will auto-restart after exit(1)

**src/handlers/credentials.ts:**
- Export `handleCredsUpdate(saveCreds: () => Promise<void>)` function
- Returns event handler that calls saveCreds on every creds.update
- Per RESEARCH.md: credentials update with every message (Signal protocol) - must save immediately

**src/handlers/connection.ts:**
- Export `handleConnectionUpdate(startSocket: () => void)` function
- Returns event handler for connection.update events
- Handle QR code: display using qrcode-terminal with {small: true}
- Handle connection === 'close': check DisconnectReason
  - If lastDisconnect.error.output.statusCode !== DisconnectReason.loggedOut → reconnect
  - If DisconnectReason.loggedOut → do NOT reconnect (prevents infinite QR loop per RESEARCH.md Pitfall 2)
- Handle connection === 'open': log "Connected to WhatsApp"
- Import { Boom } from '@hapi/boom' for error type checking
- Import qrcode-terminal for QR display

**src/index.ts:**
- Import setupErrorHandlers and call FIRST (before any other code)
- Import logger, config, useJsonAuthState
- Import makeWASocket, DisconnectReason, makeCacheableSignalKeyStore from Baileys
- Create async startSocket() function:
  1. Load auth state using useJsonAuthState('./data/auth')
  2. Create socket with makeWASocket:
     - logger: logger
     - auth: { creds: state.creds, keys: makeCacheableSignalKeyStore(state.keys, logger) }
     - generateHighQualityLinkPreview: true
  3. Register sock.ev.on('creds.update', handleCredsUpdate(saveCreds))
  4. Register sock.ev.on('connection.update', handleConnectionUpdate(startSocket))
  5. Log "Starting WhatsApp bot..."
- Call startSocket() to begin

**.env.example:**
- Template with GROUP_1_JID=120363...@g.us (example)
- GROUP_2_JID=120363...@g.us (example)
- NODE_ENV=production
- LOG_LEVEL=info
- Include comment: "Get JIDs from WhatsApp groups - format: 120363XXXXXXXXX-YYYYYYYY@g.us"

Follow RESEARCH.md code examples exactly for socket initialization and reconnection logic. Use Baileys DisconnectReason enum to prevent infinite QR loops.
  </action>
  <verify>
tsc --noEmit validates all files
grep "DisconnectReason.loggedOut" src/handlers/connection.ts confirms reconnection guard
grep "process.on" src/utils/errors.ts confirms global error handlers
grep "makeWASocket" src/index.ts confirms socket creation
npm start launches bot (will show QR code or connect if session exists)
  </verify>
  <done>
All 7 files exist and TypeScript compiles successfully
src/index.ts creates Baileys socket with custom auth state
src/handlers/connection.ts implements smart reconnection (checks DisconnectReason.loggedOut)
src/utils/errors.ts sets up global error handlers for uncaught exceptions
Bot starts and displays QR code or connects using saved session
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify WhatsApp Connection & Session Persistence</name>
  <files>N/A - verification only</files>
  <action>
CHECKPOINT: Human verification required to confirm WhatsApp connection works correctly.

Bot must:
- Display QR code on first run
- Connect successfully after scanning QR with WhatsApp
- Maintain connection without requiring re-scan
- Survive kill -9 restart (session persists)
- Reconnect automatically after network interruptions
- Handle errors gracefully (PM2 restarts on crash)

Verification steps:

**Initial Connection:**
1. Run npm install to install dependencies
2. Copy .env.example to .env
3. Get GROUP_1_JID and GROUP_2_JID from your WhatsApp groups (format: 120363XXXXXXXXX-YYYYYYYY@g.us)
4. Update .env with actual JIDs
5. Run npm start - should display QR code in terminal
6. Scan QR code with WhatsApp on your phone (Settings → Linked Devices → Link a Device)
7. Verify bot logs "Connected to WhatsApp"
8. Verify bot can see both groups

**Session Persistence:**
9. Stop the bot with Ctrl+C
10. Run npm start again - should connect WITHOUT showing QR code (using saved session)
11. Verify bot reconnects and logs "Connected to WhatsApp"

**Crash Recovery:**
12. Run pm2 start ecosystem.config.js
13. Check pm2 logs - should show successful connection
14. Kill process: pm2 restart soccer-bot
15. Verify PM2 restarts bot automatically and reconnects without QR

**Force Kill Recovery:**
16. Run pm2 delete soccer-bot then pm2 start ecosystem.config.js
17. Verify session files in data/auth/ (creds.json, keys.json) are valid JSON
18. Verify bot reconnects without QR code

Expected outcomes:
- QR code appears only on first run
- Subsequent runs connect using saved session
- kill -9 does NOT corrupt session files
- PM2 auto-restarts the bot
- Bot reconnects after network interruptions
- No infinite QR code loops
  </action>
  <verify>
Human testing and approval required. Follow verification steps above.
  </verify>
  <done>
User confirms:
- Initial QR connection works
- Session persists across restarts
- No QR re-scan needed after kill -9
- PM2 auto-restart works
- Reconnection logic prevents infinite loops
User types "approved" or reports specific issues
  </done>
</task>

</tasks>

<verification>
1. All TypeScript files compile without errors (tsc --noEmit)
2. Bot displays QR code on first run and connects after scan
3. Bot reconnects without QR code after restart (session persists)
4. Bot handles kill -9 without session corruption (write-file-atomic works)
5. Bot reconnects automatically after network disconnect
6. Bot does NOT infinite-loop on logout (DisconnectReason.loggedOut check works)
7. PM2 can start and restart the bot successfully
8. Global error handlers catch uncaught exceptions and allow clean restart
</verification>

<success_criteria>
- Bot connects to WhatsApp via Baileys and authenticates via QR code (first run only)
- Bot maintains connection to both Group 1 (managers) and Group 2 (players) with JIDs from env
- Bot survives kill -9 restart without requiring QR re-scan (session persists atomically)
- Bot handles unexpected disconnections and reconnects automatically (connection.update handler)
- Unhandled errors don't crash the process permanently (global error handler + PM2 auto-restart)
- All Phase 1 success criteria from ROADMAP.md are met
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-connection/01-02-SUMMARY.md`
</output>
